# =============================================================================
# AI Readiness Report Pipeline
# =============================================================================
# This pipeline generates a daily report scoring the repository's AI-readiness.
# It checks for the presence and quality of AI agent configuration files.
#
# SETUP:
#   1. Add repository variables in Bitbucket:
#      Settings → Repository variables
#      - LLM_API_KEY (secured): Your LLM provider API key
#      - LLM_MODEL: e.g., "anthropic/claude-sonnet-4-5-20250929"
#      - LLM_BASE_URL: e.g., "https://api.anthropic.com/v1" (optional)
#
#   2. To schedule daily runs:
#      Settings → Pipelines → Schedules → Add schedule
#      - Branch: main
#      - Pipeline: custom: ai-readiness-report
#      - Schedule: Daily at your preferred time
#
# =============================================================================

image: python:3.12

definitions:
  steps:
    - step: &ai-readiness-report
        name: Generate AI Readiness Report
        caches:
          - pip
        script:
          # DEBUG: Commenting out tmux to investigate SubprocessTerminal failure
          # - apt-get update && apt-get install -y tmux

          # DEBUG: Investigate bash environment before OpenHands SDK runs
          - echo "=== DEBUG: Bash Environment Investigation ==="
          - echo "Bash version:"
          - bash --version
          - echo ""
          - echo "Current shell:"
          - echo $SHELL
          - echo ""
          - echo "PS1 value:"
          - echo "$PS1"
          - echo ""
          - echo "PROMPT_COMMAND value:"
          - echo "$PROMPT_COMMAND"
          - echo ""
          - echo "TERM value:"
          - echo $TERM
          - echo ""
          - echo "TTY info:"
          - tty || echo "No TTY available"
          - echo ""
          - echo "Interactive shell test:"
          - echo $-
          - echo ""
          - echo "=== END DEBUG ==="

          # Install uv for fast package management
          - pip install uv

          # Install OpenHands SDK
          - uv pip install --system "openhands-sdk @ git+https://github.com/OpenHands/agent-sdk.git@main#subdirectory=openhands-sdk"
          - uv pip install --system "openhands-tools @ git+https://github.com/OpenHands/agent-sdk.git@main#subdirectory=openhands-tools"

          # Validate required variables
          - |
            if [ -z "$LLM_API_KEY" ]; then
              echo "Error: LLM_API_KEY repository variable is not set."
              echo "Go to Repository Settings → Repository variables to add it."
              exit 1
            fi

          # Run the AI readiness report script
          - python scripts/ai_readiness_report.py

          # Configure git for commits
          - git config user.name "OpenHands"
          - git config user.email "openhands@all-hands.dev"

          # Commit and push the report if there are changes
          - |
            if [ -n "$(git status --porcelain)" ]; then
              git add reports/
              git commit -m "chore: update AI readiness report"
              git push origin HEAD
            else
              echo "No changes to commit"
            fi
        artifacts:
          - reports/**
          - "*.log"

pipelines:
  # Manual trigger or scheduled runs use this custom pipeline
  custom:
    ai-readiness-report:
      - step: *ai-readiness-report

  # Optionally run on push to main (comment out if you only want scheduled runs)
  # branches:
  #   main:
  #     - step: *ai-readiness-report
