# =============================================================================
# OpenHands Demo Pipelines
# =============================================================================
# This file contains demo pipelines showcasing OpenHands SDK capabilities:
#
# 1. AI Readiness Report - Scores repository's AI-readiness
# 2. SBOM Report - Generates Software Bill of Materials with security analysis
# 3. CVE Scanner - Scans for CVEs, auto-applies fixes, and generates report
#
# SETUP:
#   1. Add repository variables in Bitbucket:
#      Settings → Repository variables
#      - LLM_API_KEY (secured): Your LLM provider API key
#      - LLM_MODEL: e.g., "anthropic/claude-sonnet-4-5-20250929"
#      - LLM_BASE_URL: e.g., "https://api.anthropic.com/v1" (optional)
#
#   2. For PR creation (recommended):
#      - OPENHANDS_BB_USERNAME: Your Bitbucket username
#      - OPENHANDS_BB_APP_PASSWORD (secured): App password with repo + PR write
#
#   3. Optional variables:
#      - CVE_FAIL_ON_CRITICAL: "true" to fail build on critical CVEs
#
#   4. To schedule runs:
#      Settings → Pipelines → Schedules → Add schedule
#      - Branch: main
#      - Pipeline: custom: cve-scanner (recommended weekly)
#      - Schedule: Weekly at your preferred time
#
# =============================================================================

image: python:3.12

definitions:
  steps:
    - step: &ai-readiness-report
        name: Generate AI Readiness Report
        caches:
          - pip
        script:
          - pip install uv

          # Install OpenHands SDK
          - uv pip install --system "openhands-sdk @ git+https://github.com/OpenHands/software-agent-sdk.git#subdirectory=openhands-sdk"
          - uv pip install --system "openhands-tools @ git+https://github.com/OpenHands/software-agent-sdk.git#subdirectory=openhands-tools"

          # Validate required variables
          - |
            if [ -z "$LLM_API_KEY" ]; then
              echo "Error: LLM_API_KEY repository variable is not set."
              echo "Go to Repository Settings → Repository variables to add it."
              exit 1
            fi

          # Run the AI readiness report script
          - python scripts/ai_readiness_report.py

          # Configure git for commits
          - git config user.name "OpenHands"
          - git config user.email "openhands@all-hands.dev"

          # Create PR or push directly based on available credentials
          - |
            if [ -n "$(git status --porcelain)" ]; then
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              BRANCH_NAME="openhands/ai-readiness-$TIMESTAMP"

              git add reports/
              git commit -m "chore: update AI readiness report"

              if [ -n "$OPENHANDS_BB_USERNAME" ] && [ -n "$OPENHANDS_BB_APP_PASSWORD" ]; then
                echo "Creating PR for changes..."
                git checkout -b "$BRANCH_NAME"
                git push origin "$BRANCH_NAME"

                # Create PR via Bitbucket API
                curl -s -X POST \
                  -u "$OPENHANDS_BB_USERNAME:$OPENHANDS_BB_APP_PASSWORD" \
                  "https://api.bitbucket.org/2.0/repositories/$BITBUCKET_REPO_OWNER/$BITBUCKET_REPO_SLUG/pullrequests" \
                  -H "Content-Type: application/json" \
                  -d "{
                    \"title\": \"chore: update AI readiness report\",
                    \"source\": { \"branch\": { \"name\": \"$BRANCH_NAME\" } },
                    \"destination\": { \"branch\": { \"name\": \"main\" } },
                    \"close_source_branch\": true
                  }"
                echo ""
                echo "PR created successfully!"
              else
                echo "No BB credentials, pushing directly to main..."
                git push origin HEAD
              fi
            else
              echo "No changes to commit"
            fi
        artifacts:
          - reports/**
          - "*.log"

    - step: &sbom-report
        name: Generate SBOM Report
        caches:
          - pip
        script:
          - pip install uv

          # Install OpenHands SDK
          - uv pip install --system "openhands-sdk @ git+https://github.com/OpenHands/software-agent-sdk.git#subdirectory=openhands-sdk"
          - uv pip install --system "openhands-tools @ git+https://github.com/OpenHands/software-agent-sdk.git#subdirectory=openhands-tools"

          # Install curl for syft installation
          - apt-get update && apt-get install -y curl

          # Validate required variables
          - |
            if [ -z "$LLM_API_KEY" ]; then
              echo "Error: LLM_API_KEY repository variable is not set."
              echo "Go to Repository Settings → Repository variables to add it."
              exit 1
            fi

          # Run the SBOM report script
          - python scripts/sbom_report.py

          # Configure git for commits
          - git config user.name "OpenHands"
          - git config user.email "openhands@all-hands.dev"

          # Create PR or push directly based on available credentials
          - |
            if [ -n "$(git status --porcelain)" ]; then
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              BRANCH_NAME="openhands/sbom-$TIMESTAMP"

              git add reports/
              git commit -m "chore: update SBOM report"

              if [ -n "$OPENHANDS_BB_USERNAME" ] && [ -n "$OPENHANDS_BB_APP_PASSWORD" ]; then
                echo "Creating PR for changes..."
                git checkout -b "$BRANCH_NAME"
                git push origin "$BRANCH_NAME"

                # Create PR via Bitbucket API
                curl -s -X POST \
                  -u "$OPENHANDS_BB_USERNAME:$OPENHANDS_BB_APP_PASSWORD" \
                  "https://api.bitbucket.org/2.0/repositories/$BITBUCKET_REPO_OWNER/$BITBUCKET_REPO_SLUG/pullrequests" \
                  -H "Content-Type: application/json" \
                  -d "{
                    \"title\": \"chore: update SBOM report\",
                    \"source\": { \"branch\": { \"name\": \"$BRANCH_NAME\" } },
                    \"destination\": { \"branch\": { \"name\": \"main\" } },
                    \"close_source_branch\": true
                  }"
                echo ""
                echo "PR created successfully!"
              else
                echo "No BB credentials, pushing directly to main..."
                git push origin HEAD
              fi
            else
              echo "No changes to commit"
            fi
        artifacts:
          - reports/**
          - "*.log"

    - step: &cve-scanner
        name: CVE Scanner & Auto-Fix
        caches:
          - pip
        script:
          - pip install uv

          # Install OpenHands SDK
          - uv pip install --system "openhands-sdk @ git+https://github.com/OpenHands/software-agent-sdk.git#subdirectory=openhands-sdk"
          - uv pip install --system "openhands-tools @ git+https://github.com/OpenHands/software-agent-sdk.git#subdirectory=openhands-tools"

          # Install curl for grype installation and Node.js for npm
          - apt-get update && apt-get install -y curl nodejs npm

          # Validate required variables
          - |
            if [ -z "$LLM_API_KEY" ]; then
              echo "Error: LLM_API_KEY repository variable is not set."
              echo "Go to Repository Settings → Repository variables to add it."
              exit 1
            fi

          # Run the CVE scanner - analyzes vulnerabilities, applies fixes, generates report
          - python scripts/cve_report.py

          # Configure git for commits
          - git config user.name "OpenHands"
          - git config user.email "openhands@all-hands.dev"

          # Create PR or push directly based on available credentials
          - |
            if [ -n "$(git status --porcelain)" ]; then
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              BRANCH_NAME="openhands/cve-fixes-$TIMESTAMP"

              git add -A
              git commit -m "fix: apply CVE security patches

            Automated security fixes applied by OpenHands CVE scanner.
            See reports/cve-*.md for details."

              if [ -n "$OPENHANDS_BB_USERNAME" ] && [ -n "$OPENHANDS_BB_APP_PASSWORD" ]; then
                echo "Creating PR for CVE fixes..."
                git checkout -b "$BRANCH_NAME"
                git push origin "$BRANCH_NAME"

                # Create PR via Bitbucket API
                curl -s -X POST \
                  -u "$OPENHANDS_BB_USERNAME:$OPENHANDS_BB_APP_PASSWORD" \
                  "https://api.bitbucket.org/2.0/repositories/$BITBUCKET_REPO_OWNER/$BITBUCKET_REPO_SLUG/pullrequests" \
                  -H "Content-Type: application/json" \
                  -d "{
                    \"title\": \"fix: apply CVE security patches\",
                    \"source\": { \"branch\": { \"name\": \"$BRANCH_NAME\" } },
                    \"destination\": { \"branch\": { \"name\": \"main\" } },
                    \"close_source_branch\": true
                  }"
                echo ""
                echo "PR created successfully!"
              else
                echo "No BB credentials, pushing directly to main..."
                git push origin HEAD
              fi
            else
              echo "No CVE fixes needed"
            fi
        artifacts:
          - reports/**
          - "*.log"

pipelines:
  # Manual trigger or scheduled runs use these custom pipelines
  custom:
    ai-readiness-report:
      - step: *ai-readiness-report
    sbom-report:
      - step: *sbom-report
    cve-scanner:
      - step: *cve-scanner

  # Optionally run on push to main (comment out if you only want scheduled runs)
  # branches:
  #   main:
  #     - step: *ai-readiness-report
  #     - step: *cve-scanner  # Weekly CVE scan recommended
